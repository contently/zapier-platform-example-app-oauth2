# "OAuth2" Example App For Zapier Platform

[![Build Status](https://travis-ci.org/zapier/zapier-platform-example-app-oauth2.svg?branch=master)](https://travis-ci.org/zapier/zapier-platform-example-app-oauth2)

A barebones app that has OAuth2 setup to interact with Contently!

## Current Oauth2 Flow:

For the official Zapier documentation, visit: https://github.com/zapier/zapier-platform-cli#oauth2

The Zapier code for authentication can be found in `/authentication.js` and the flow is as follows:

- `authorizeUrl` calls Contently's `/authorize` enpoint, passing various params including:
  -  `state` used by Zapier for verification purposes
  - `redirect_uri` generated by Zapier

```js 
// ...

module.exports = {
  type: 'oauth2',
  oauth2Config: {
    authorizeUrl: {
      url: `${process.env.BASE_URL}/oauth2/authorize`,
      params: {
        client_id: '{{process.env.CLIENT_ID}}',
        state: '{{bundle.inputData.state}}',
        redirect_uri: '{{bundle.inputData.redirect_uri}}',
        response_type: 'code'
      }
    },

// ...
```

- User is directed to Contently's login view, as route is secured

- the `/authorize` controller creates a `TempCode` instance with attributes:
  - `user` the contently user whose credentials were verified by login
  - `code` a string generated on the model instance on save

- After the `TempCode` instance is saved, controller redirects to the Zapier `redirect_uri`, sending back the `code` attribute value and the `state` param

- Zapier calls the `getAccessToken` function, hitting the `/access_token` endpoint at Contently with params including:
  - `code` the string attribute generated by Contently's `/authorize` controller, automatically saved by Zapier in `bundle.inputData`

- The `/access_token` controller finds the `TempCode` instance with matching `code` attribute and creates a `UserIntegration` instance with attributes:
  - `access_token` a NEW string to serve as the permament token
  - `user` the user originally associated with the `TempCode`

- the `TempCode` instance is destroyed and the `access_code` attribute is returned as JSON

- JSON is recieved via `promise` in `getAccessToken` back in Zapier app, which returns the `access_token`, thus setting it in `bundle.authData`